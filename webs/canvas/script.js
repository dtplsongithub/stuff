
const canvas = document.querySelector('canvas');
const ctx = canvas.getContext('2d');
const FPS = 30;
var step = 0;

canvas.width = 864;
canvas.height = 648; 

var roaddata = [[393,33],[405,33],[457,33],[510,33],[564,33],[614,33],[652,43],[677,69],[672,124],[619,155],[585,200],[538,241],[492,250],[448,277],[389,299],[326,279],[312,238],[304,229],[294,245],[274,310],[265,357],[265,423],[281,447],[333,450],[378,436],[416,420],[434,391],[459,371],[493,333],[497,324],[510,304],[538,285],[556,265],[571,249],[592,243],[619,220],[672,207],[733,200],[821,202],[852,225],[866,243],[868,342],[871,403],[855,475],[826,520],[754,560],[686,573],[618,573],[567,569],[526,582],[484,621],[398,641],[324,645],[232,639],[128,628],[65,589],[45,549],[42,522],[38,456],[33,400],[27,319],[20,200],[40,132],[88,60],[160,51],[279,42],[393,33],/**/[360,115],[335,115],[243,119],[216,132],[150,141],[117,164],[108,214],[105,263],[114,315],[114,340],[114,398],[126,486],[148,542],[193,553],[209,556],[231,556],[286,564],[306,558],[340,560],[360,558],[387,551],[427,542],[438,542],[475,522],[513,495],[560,479],[625,481],[675,492],[708,486],[717,484],[747,474],[767,448],[787,396],[785,312],[780,279],[709,283],[690,290],[659,299],[632,312],[623,315],[605,339],[576,366],[560,378],[538,405],[520,414],[490,465],[465,486],[439,497],[423,504],[389,520],[339,533],[259,535],[207,531],[189,495],[182,418],[177,353],[180,294],[195,250],[211,191],[240,166],[292,146],[335,148],[360,155],[391,195],[420,186],[463,175],[492,168],[519,151],[537,123],[537,115],[360,115]]

var offroaddata = [[0,97],[13,90],[67,50],[101,0],[43,0],[34,0],[0,0],[0,61],[0,103],/**/[0,508],[0,508],[22,520],[29,535],[34,560],[43,608],[63,623],[76,623],[103,635],[117,648],[0,648],[0,583],[0,648],/**/[482,648],[500,625],[535,598],[574,585],[608,578],[643,578],[697,571],[772,576],[805,558],[859,509],[864,504],[864,596],[864,648],[657,648],[497,648],[0,648],/**/ [864,0,"off" ], [864,189, "on" ],/**/[864,187],[851,180],[772,180],[691,176],[650,178],[644,178],[630,171],[612,171],[590,189],[569,211],[544,232],[526,248],[508,256],[477,286],[450,310],[405,338],[376,369],[353,383],[315,403],[304,405],[293,398],[286,382],[290,351],[290,335],[290,302],[292,299],[292,299],[295,299],[299,306],[306,308],[337,306],[362,295],[392,290],[421,279],[454,257],[482,247],[484,241],[526,227],[549,220],[572,189],[607,157],[646,139],[661,113],[661,65],[661,22],[661,0],[668,0],[855,0],[864,0],[864,5],[864,167],[864,173],[0,0,"off"],[339,114,"on"],[349,114],[364,112],[382,112],[418,112],[429,114],[447,119],[477,128],[486,144],[470,159],[456,168],[421,177],[378,162],[364,146],[337,146],[303,146],[258,164],[232,168],[211,191],[196,205],[182,245],[169,270],[162,321],[151,339],[151,353],[151,357],[159,371],[160,405],[164,443],[166,472],[168,483],[180,502],[198,501],[207,519],[225,535],[259,537],[312,537],[351,535],[366,522],[403,515],[459,490],[486,465],[506,452],[520,438],[546,425],[558,414],[567,391],[598,360],[609,342],[636,312],[659,304],[697,304],[726,306],[749,321],[762,324],[760,333],[753,333],[753,340],[756,349],[756,364],[758,391],[740,421],[711,443],[664,461],[601,463],[564,472],[535,484],[522,486],[502,495],[477,502],[461,535],[414,553],[364,556],[299,558],[247,562],[200,553],[191,544],[191,542],[173,544],[166,538],[151,528],[146,508],[137,484],[132,447],[126,409],[119,360],[121,331],[121,304],[123,276],[132,225],[150,204],[173,177],[187,162],[211,141],[243,124],[277,114],[313,112],[319,112]] 
for (var a=40;a<85;a++) {
  offroaddata[a][0]=offroaddata[a][0]+20;
  offroaddata[a][1]=offroaddata[a][1]+20
}
var camPA = [0,0,0];
var timestr = "";
let player = {pos:{x:100,y:100},rotation:{using:0,render:0},display:{link:"kart.png"}};
let playerimg = new Image();
playerimg.src=player.display.link;
let isplayerloaded = false;
playerimg.onload = (()=>{
	isplayerloaded=true;
})
let keyb = [];
document.addEventListener("keydown",function(e){
	if(keyb.indexOf(e.keyCode)==-1){
		keyb.push(e.keyCode)
	}
})

document.addEventListener("keyup",function(e){
	if(keyb.indexOf(e.keyCode)!=-1){
		keyb.splice(keyb.indexOf(e.keyCode), 1);
	}
})
function update() {
    
  ctx.clearRect(0,0, 864, 648);
  ctx.fillStyle = '#46ff35'
  ctx.fillRect(0 , 0 , 864 , 648);
  timestr = step/FPS
  timestr=timestr.toFixed(3)
	player.rotation.render=player.rotation.using
	//ctx.rotate(0-player.rotation.using)

  road();
  offroad();
	if(keyb.indexOf(37)/* left key */!=-1){
		player.rotation.using+=-3/FPS
	}
	if(keyb.indexOf(38)/* up key */!=-1){
		player.pos.x+=7
	}
	if(keyb.indexOf(39)/* right key */!=-1){
		player.rotation.using+=3/FPS
	}
	if(keyb.indexOf(40)/* down key */!=-1){
		player.pos.x+=-5
	}
	if(isplayerloaded){
		let cx = player.pos.x + 0.5 * 23;   // x of shape center
		let cy = player.pos.y + 0.5 * 23;  // y of shape center
		ctx.setTransform(cx,0,0,cy,0,0)
		ctx.rotate(player.rotation.using)
		ctx.setTransform(cx,0,0,cy,0,0)
		ctx.drawImage(playerimg,player.pos.x,player.pos.y)
		ctx.rotate(0-player.rotation.using)
	}
ctx.setTransform(0,0,0,0,0,0)
  step++;
  ctx.font = '28px Arial';
  ctx.fillStyle = 'black';
  ctx.fillText(timestr, 700, 30);
 //	ctx.fillText(keyb, 30, 500);

}




function road() {
    ctx.translate(0,0);
  ctx.fillStyle = '#4f4f4f'
  ctx.beginPath();
  ctx.moveTo(roaddata[0][0],roaddata[0][1]);
  ctx.lineTo(roaddata[1][0],roaddata[1][1]);
  ctx.stroke();
  for(var i=2;i<roaddata.length;i++) {
    
    ctx.lineTo(roaddata[i][0],roaddata[i][1]);
  }
  ctx.closePath();
  ctx.stroke();
  ctx.fill();
}
function offroad() {
    ctx.translate(0,0);
  ctx.fillStyle = '#086300'
  ctx.beginPath();
  ctx.moveTo(offroaddata[0][0],offroaddata[0][1]);
  ctx.lineTo(offroaddata[1][0],offroaddata[1][1]);
  ctx.stroke();
  for(var i=2;i<offroaddata.length;i++) {
    if(offroaddata[i][2]=="off"){
      ctx.closePath();
      ctx.stroke();
      ctx.fill();
      
    }else if(offroaddata[i][2]=="on"){
      ctx.beginPath();
      ctx.moveTo(offroaddata[i][0],offroaddata[i][1])
    }else{
    ctx.lineTo(offroaddata[i][0],offroaddata[i][1]);
      
    } 
  }
  ctx.closePath();
  ctx.stroke();
  ctx.fill();
}
setInterval(update, 1000/FPS)
//#086300
